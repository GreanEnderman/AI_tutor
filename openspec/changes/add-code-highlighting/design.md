# 设计：代码语法高亮系统

## 背景
AI家教当前使用marked.js进行Markdown渲染，代码块只有基础样式。需要集成语法高亮功能来提升代码可读性，同时保持与现有系统的兼容性和性能。

## 目标 / 非目标
- 目标：
  - 为代码块添加语法高亮
  - 支持多种编程语言
  - 保持良好的性能
  - 提供良好的用户体验
  - 与现有数学公式渲染兼容
- 非目标：
  - 修改现有的Markdown解析逻辑
  - 改变数学公式渲染
  - 复杂的代码编辑功能

## 决策
- 决策：使用Prism.js作为语法高亮库
  - 理由：轻量级、高性能、支持多种语言、易于集成
  - 考虑的替代方案：highlight.js（更重但功能更全）、自实现（复杂度高）
- 决策：异步加载语言包
  - 理由：减少初始加载时间，按需加载特定语言
  - 考虑的替代方案：一次性加载所有语言包（增加初始大小）
- 决策：集成到现有marked渲染器
  - 理由：保持现有架构，最小化代码变更
  - 考虑的替代方案：完全重写渲染逻辑（风险高）

## 风险 / 权衡
- 性能影响 → 异步加载、渲染缓存
- 库大小增加 → 按需加载、压缩版本
- 兼容性问题 → 全面测试、渐进式升级
- 流式渲染复杂性 → 智能缓存、延迟高亮

## 技术方案
### 核心组件
1. **语法高亮引擎**：Prism.js核心库
2. **语言检测**：基于代码块语言标识和自动检测
3. **渲染集成**：扩展现有marked.Renderer
4. **UI增强**：复制按钮、行号、语言标签

### 集成策略
1. 在index.html中添加Prism.js引用
2. 修改GLMRenderer类，集成语法高亮功能
3. 扩展CSS样式，添加高亮主题
4. 实现性能优化（缓存、异步加载）

## 迁移计划
1. 添加Prism.js库和CSS到index.html
2. 修改GLMRenderer，集成语法高亮
3. 更新CSS样式，添加高亮主题
4. 实现性能优化功能
5. 全面测试和兼容性验证
6. 回滚：保留原始渲染逻辑作为降级方案

## 开放问题
- 支持哪些编程语言（初始集合）？
- 是否需要行号显示？
- 代码复制功能的实现方式？
- 主题样式选择（亮色/暗色）？
- 流式渲染中的高亮时机？